<!DOCTYPE html>
<html>
<head>
<title>Time Menu App</title>
<meta name="viewport" content="initial-scale=1.0, width=device-width" />
<link rel="stylesheet" href="css/style.css" type="text/css" media="all" />
<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script type = text/javascript>

    var totalTime = 0;
    var totalLists = 0;
    var drinks = ['Select a drink', 'Espresso', 'Macchiato', 'Flat white', 'Cappuccino', 'Latte', 'Hot chocolate', 'Mocha'];
    var selectedDrinks = [];
    var list = null;
    var refreshRate = 3000;

    $(document).ready(function()
    {
    	function generateTime()
    	{
    		return (Math.floor(Math.random() * 600) + 1);
		}

    	function newDropDown()
	    {
	    	totalLists++;
	    	var removeBt = '';

	    	if( !list )
	    	{
		    	var output = '';	
		    	
		    	for( var i = 0; i < 8; i++ )
		    	{
		    		var time = generateTime();
		    		var timeTxt = "";
		    		var minutes = Math.floor(time / 60);
		    		var seconds = time - minutes * 60;

		    		if( i > 0 )
		    		{
			    		if( seconds < 10 )
			    			timeTxt = minutes+":0"+seconds;
						else
							timeTxt = minutes+":"+seconds;

						output += "<option class='drink-item' value="+time+" >"+drinks[i]+" "+timeTxt+"</option>";
					}
					else
			    		output += "<option class='drink-item' value='0'>"+drinks[i]+"</option>";
		    	}

		    	list = "<p><select class='drinks' id='drinks-list-"+totalLists+"'>"+output+"</select>";
		    }
		    else
		    	removeBt = '<a class="removeBt" href="javascript:void(0)">Remove entry</a>';

	    	$('#form').append(list + removeBt + "</p>");
	    }

	    function updateLists()
	    {
	    	totalTime = 0;

	    	$( ".drinks" ).each(function( index )
	    	{
	    		totalTime += Number( $(this).find(':selected').val() );
	    		selectedDrinks[index] = $(this).prop("selectedIndex");
	    		//console.log( $(this).find(':selected').val() );
	    		//console.log(selectedDrinks[index]);
			});

			var minutes = Math.floor(totalTime / 60);
    		var seconds = totalTime - minutes * 60;

    		if( seconds < 10 )
    			$('#total').html(minutes+":0"+seconds);
			else
				$('#total').html(minutes+":"+seconds);
	    }

		function reset()
		{
			if( !$("#content select").is(":focus") )
			{
				$('#form').empty();

				var total = totalLists;
				totalLists = 0;
				totalTime = 0;
				list = null;

				for( var i = 0; i < total; i++ )
				{
					newDropDown();
				}

				$( ".drinks" ).each(function( index )
		    	{
		    		$(this).prop("selectedIndex", selectedDrinks[index]);
		    	});

		    	selectedDrinks.length = 0;

				updateLists();
			}
		}

		// Start the app
		newDropDown();

		// UI trigger events
		$('#newBt').click(function()
	    {
			newDropDown();
	    });

	    $('.removeBt').live('click', function()
	    {
	    	$(this).parent().remove();
	    	updateLists();
	    	totalLists--;
	    });

	    $( ".drinks" ).live('change', function()
	    {
	    	updateLists();
	    	$(this).blur();
		});

		// Update UI
		setInterval( reset, refreshRate );
	});

</script>
</head>
<body>
	<div id="header"></div>
	<div id="content">
		<form method="get" name="form" id="form"></form>
	</div>
	<div id="footer">
		<a id="newBt" href="javascript:void(0)">Add entry</a>
		<p id="total">0:00</p>
	</div>
</body>
</html>